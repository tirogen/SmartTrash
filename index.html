<!--

=========================================================
* Argon Dashboard - v1.1.0
=========================================================

* Product Page: https://www.creative-tim.com/product/argon-dashboard
* Copyright 2019 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md)

* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Embedded System Laboratory 2110366 (2019/1)</title>
  <!-- Favicon -->
  <link href="./assets/img/brand/favicon.png" rel="icon" type="image/png">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <!-- Icons -->
  <link href="./assets/js/plugins/nucleo/css/nucleo.css" rel="stylesheet" />
  <link href="./assets/js/plugins/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="./assets/css/argon-dashboard.css?v=1.1.0" rel="stylesheet" />
</head>

<body class="">
  <div class="main-content">
    <!-- Navbar -->
    <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
      <div class="container-fluid">
        <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block" href="/">Embedded System Laboratory 2110366 (2019/1)</a>
      </div>
    </nav>
    <!-- End Navbar -->
    <!-- Header -->
    <div class="header bg-gradient-primary pb-8 pt-5 pt-md-8">
      <div class="container-fluid">
        <div class="header-body">
          <!-- Card stats -->
          <div class="row">
            <div class="col-xl-3 col-lg-6">
              <div class="card card-stats mb-4 mb-xl-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Recent Garbage</h5>
                      <span class="h2 font-weight-bold mb-0" id="garbage"></span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                        <i class="fas fa-align-justify"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="card card-stats mb-4 mb-xl-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Status</h5>
                      <span class="h2 font-weight-bold mb-0" id="status"></span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-info text-white rounded-circle shadow">
                        <i class="fas fa-cog"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="card card-stats mb-4 mb-xl-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Recent open</h5>
                      <span class="h4 font-weight-bold mb-0" id="recent_open"></span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-warning text-white rounded-circle shadow">
                        <i class="far fa-folder-open"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="card card-stats mb-4 mb-xl-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Today open</h5>
                      <span class="h2 font-weight-bold mb-0" id="today_open"></span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-yellow text-white rounded-circle shadow">
                        <i class="fas fa-bolt"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid mt--7">
      <div class="row">
        <div class="col-xl-8 mb-5 mb-xl-0">
          <div class="card bg-gradient-default shadow">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-uppercase text-light ls-1 mb-1">Overview</h6>
                  <h2 class="text-white mb-0">Garbage 12 hours history</h2>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- Chart -->
              <div class="chart">
                <!-- Chart wrapper -->
                <canvas id="garbage_history" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-4">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-uppercase text-muted ls-1 mb-1">Stats</h6>
                  <h2 class="mb-0">Open time</h2>
                </div>
              </div>
            </div>
            <div class="card-body">
              <table class="table align-items-center table-flush">
                <tbody id="open_time"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-5">
        <div class="col-xl-8 mb-5 mb-xl-0">
          <div class="card shadow">
            <div class="card-header border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0">Garbage stats</h3>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <!-- Projects table -->
              <table class="table align-items-center table-flush">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Proportion</th>
                    <th scope="col">Time</th>
                  </tr>
                </thead>
                <tbody id="garbage_stats"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-xl-4">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-uppercase text-muted ls-1 mb-1">Stats</h6>
                  <h2 class="mb-0">Close time</h2>
                </div>
              </div>
            </div>
            <div class="card-body">
              <table class="table align-items-center table-flush">
                <tbody id="close_time"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- Footer -->
      <footer class="footer">
        <div class="row align-items-center justify-content-xl-between">
          <div class="col-xl-6">
            <div class="copyright text-center text-xl-left text-muted">
              &copy; 2018 <a href="https://www.creative-tim.com" class="font-weight-bold ml-1" target="_blank">Creative Tim</a>
            </div>
          </div>
          <div class="col-xl-6">
            <ul class="nav nav-footer justify-content-center justify-content-xl-end">
              <li class="nav-item">
                <a href="https://www.creative-tim.com" class="nav-link" target="_blank">Creative Tim</a>
              </li>
              <li class="nav-item">
                <a href="https://www.creative-tim.com/presentation" class="nav-link" target="_blank">About Us</a>
              </li>
              <li class="nav-item">
                <a href="http://blog.creative-tim.com" class="nav-link" target="_blank">Blog</a>
              </li>
              <li class="nav-item">
                <a href="https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md" class="nav-link" target="_blank">MIT License</a>
              </li>
            </ul>
          </div>
        </div>
      </footer>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha256-R4pqcOYV8lt7snxMQO/HSbVCFRPMdrhAFMH+vr9giYI=" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase.js"></script>
  <script>
    // TODO: Replace the following with your app's Firebase project configuration
    var firebaseConfig = {
      apiKey: "AIzaSyBN3AkAcrPSD8qx-iSsiD1Q0n2NLEJCnWA",
      authDomain: "smarttrash-55130.firebaseapp.com",
      databaseURL: "https://smarttrash-55130.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    var recentGarbageRef = firebase.database().ref('recentGarbage');
    recentGarbageRef.on('value', function(snapshot) {
      $("#garbage").text(snapshot.val());
      if(snapshot.val()>=0.8){
        $("#status").text("Full");
      }else{
        $("#status").text("Not full");
      }
    });

    var recentOpenRef = firebase.database().ref('time/open').orderByKey().limitToLast(1);
    recentOpenRef.on('value', function(snapshot) {
      let date = moment(Object.values(snapshot.val())[0]).subtract(7, 'h');
      $("#recent_open").text(date.format('dddd HH:mm:ss'));
    });

    var todayOpenRef = firebase.database().ref('time/open');
    todayOpenRef.on('value', function(snapshot) {
      let d = moment().set({'hour': 0, 'minute': 0, 'second': 0, 'millisecond':0})
      let items = Object.values(snapshot.val())
      let result = items.filter((item) => {
        let c = moment(item).subtract(7, 'h');
        return c>d
      })
      $("#today_open").text(`${result.length} times`);
    });

    var garbageHistoryRef = firebase.database().ref('garbageHistory');
    garbageHistoryRef.on('value', function(snapshot) {
      let d12Hago = new Date(Date.now()-1000*60*60*12);
      let items = Object.values(snapshot.val())
      let result = items.filter((item) => {
        let current = new Date(item.timestamp);
        return current>d12Hago
      })

      let x = [];
      let y = [];
      let startAt = moment().set({'minute': 0, 'second': 0, 'millisecond':0});
      let endAt = moment().set({'minute': 0, 'second': 0, 'millisecond':0}).add(1, 'h');
      let i;
      for(i=0;i<12;i++){
        let toY;
        result.forEach(item => {
          let time = moment(item.timestamp).subtract(7, 'h');
          if((i==0 && time>startAt)||(i!=0 && time>startAt && time<endAt)){
            toY = item.quantity;
          }
        });
        y.push(toY)
        //lastest value of 12.xxxx is in 12.00
        x.push(startAt.format("HH"))
        startAt.subtract(1, 'h')
        endAt.subtract(1, 'h')
      }

      new Chart(document.getElementById('garbage_history').getContext('2d'), {
          type: 'line',
          data: {
              labels: x.reverse(),
              datasets: [{
                  label: 'Trash level',
                  borderWidth: 4,
                  borderColor: '#5e71e4',
                  data: y.reverse(),
                  pointStyle: 'triangle',
                  steppedLine: true
              }]
          },
          options: {
            legend: {
               display: false
            },
            scales: {
              yAxes: [{
                scaleLabel: {
                  display: true,
                  fontColor: "#8494a6",
                  fontSize: 16,
                  labelString: 'proportion'
                },
                ticks: {
                  fontColor: "#8494a6",
                  fontSize: 16
                }
              }],
              xAxes: [{
                scaleLabel: {
                  display: true,
                  fontColor: "#8494a6",
                  fontSize: 16,
                  labelString: 'time'
                },
                ticks: {
                  fontColor: "#8494a6",
                  fontSize: 16
                }
              }]
            },
          }
      });


    });

    var openTimeRef = firebase.database().ref('time/open').orderByKey().limitToLast(10);
    openTimeRef.on('value', function(snapshot) {
      let items = Object.values(snapshot.val()).reverse()
      let result = '';
      items.forEach(item => {
        result += '<tr><th scope="row">'+moment(item).subtract(7, 'h').format('dddd, D MMMM YYYY, HH:mm:ss')+'</th></tr>';
      })
      $("#open_time").html(result);
    });

    var closeTimeRef = firebase.database().ref('time/close').orderByKey().limitToLast(10);
    closeTimeRef.on('value', function(snapshot) {
      let items = Object.values(snapshot.val()).reverse()
      let result = '';
      items.forEach(item => {
        result += '<tr><th scope="row">'+moment(item).subtract(7, 'h').format('dddd, D MMMM YYYY, HH:mm:ss')+'</th></tr>';
      })
      $("#close_time").html(result);
    });

    var garbageStatsRef = firebase.database().ref('garbageHistory').orderByKey().limitToLast(50);
    garbageStatsRef.on('value', function(snapshot) {
      let items = Object.values(snapshot.val()).reverse()
      let result = '';
      items.forEach(item => {
        result += '<tr><th scope="row">'+item.quantity+'</th><th>'+moment(item.timestamp).subtract(7, 'h').format('dddd, D MMMM YYYY, HH:mm:ss')+'</th></tr>';
      })
      $("#garbage_stats").html(result);
    });
  </script>
</body>

</html>
